<!DOCTYPE html>
<html>
  <head>
    <title>Chat Dashboard</title>
    <!-- Include Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Custom styles (optional) -->
    <style>
      .user-container {
        display: flex;
        flex-wrap: wrap;
      }
      .user-panel {
        border: 1px solid #dee2e6;
        margin: 10px;
        padding: 10px;
        width: 300px;
        height: 400px;
        overflow-y: scroll;
        background-color: #f8f9fa;
        border-radius: 5px;
      }
      .user-panel h2 {
        margin-top: 0;
        font-size: 1.25rem;
      }
      .message {
        margin-bottom: 5px;
      }
      .timestamp {
        color: gray;
        font-size: small;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!--<h1>Chat Dashboard</h1>-->
      <!-- Bootstrap Tabs -->
      <ul class="nav nav-tabs" id="messageTabs" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="chatMessage-tab"
            data-toggle="tab"
            href="#chatMessage"
            role="tab"
            aria-controls="chatMessage"
            aria-selected="true"
            >Chat Messages</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="privateMessage-tab"
            data-toggle="tab"
            href="#privateMessage"
            role="tab"
            aria-controls="privateMessage"
            aria-selected="false"
            >Private Messages</a
          >
        </li>
      </ul>
      <div class="tab-content" id="messageTabsContent">
        <!-- Chat Messages Tab Pane -->
        <div
          class="tab-pane fade show active"
          id="chatMessage"
          role="tabpanel"
          aria-labelledby="chatMessage-tab"
        >
          <div class="user-container" id="chatMessage-container">
            <!-- User panels for chat messages will be added here -->
          </div>
        </div>
        <!-- Private Messages Tab Pane -->
        <div
          class="tab-pane fade"
          id="privateMessage"
          role="tabpanel"
          aria-labelledby="privateMessage-tab"
        >
          <div class="user-container" id="privateMessage-container">
            <!-- User panels for private messages will be added here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Include Socket.IO client -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <!-- Include jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Your JavaScript code will go here -->
    <script>
      const socket = io();

      const userPanels = {
        chatMessage: {},
        privateMessage: {},
      };

      socket.on("connect", () => {
        console.log("Connected to server");
      });

      socket.on("new_message", (data) => {
        const { user, message, timestamp, method } = data;

        // Determine which container to use based on the method
        let containerId;
        if (method === "chatMessage") {
          containerId = "chatMessage-container";
        } else if (method === "privateMessage") {
          containerId = "privateMessage-container";
        } else {
          // If method is unknown, you can choose to ignore or handle it differently
          console.warn("Unknown message method:", method);
          return;
        }

        // Use separate userPanels for each method
        const userPanelsForMethod = userPanels[method];

        // Sanitize the user string for use in HTML IDs
        const sanitizedUser = user.replace(/\W/g, "_");

        // Check if user panel exists, if not create one
        if (!userPanelsForMethod[sanitizedUser]) {
          const userContainer = document.getElementById(containerId);

          const userPanel = document.createElement("div");
          userPanel.className = "user-panel";
          userPanel.id = `user-${method}-${sanitizedUser}`;

          const userHeader = document.createElement("h2");
          userHeader.textContent = `${user}`;
          userPanel.appendChild(userHeader);

          const messagesList = document.createElement("div");
          messagesList.className = "messages-list";
          userPanel.appendChild(messagesList);

          userContainer.appendChild(userPanel);

          userPanelsForMethod[sanitizedUser] = messagesList;
        }

        // Add message to user's panel
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";

        const timestampSpan = document.createElement("span");
        timestampSpan.className = "timestamp";
        timestampSpan.textContent = `[${timestamp}] `;

        const contentSpan = document.createElement("span");
        contentSpan.textContent = message;

        messageDiv.appendChild(timestampSpan);
        messageDiv.appendChild(contentSpan);

        userPanelsForMethod[sanitizedUser].appendChild(messageDiv);

        // Scroll to the bottom of the user panel
        const userPanelDiv = document.getElementById(
          `user-${method}-${sanitizedUser}`
        );
        userPanelDiv.scrollTop = userPanelDiv.scrollHeight;
      });
    </script>
  </body>
</html>
